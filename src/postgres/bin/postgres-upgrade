#!/bin/bash -e

. "$SNAP/debug.env"

trap end_debug EXIT
begin_debug

. "$SNAP/postgres.env"

if pg_version_changed; then
    echo Prepare postgres data directory
    run_as_daemon_user mv "$PG_DATA" "$PG_DATA.old"
    setup_postgres_database

    echo Upgrade postgres data
    upgrade_postgres_database && run_as_daemon_user rm -fr "$PG_DATA.old"

    echo Update postgres version file
    update_postgres_version_file
fi
