#!/bin/bash

if [ -n "${PGBOUNCER_ENV:-}" ]; then
    return
fi
PGBOUNCER_ENV=1

. "$SNAP/snap.env"
. "$SNAP/postgres.env"

update_paths pgbouncer

export PGB_PID_FILE="$PID_DIR/pgbouncer.pid"
export PGB_HOME="$SNAP_DATA/pgbouncer"
export PGB_CONFIG="$PGB_HOME/config"
export PGB_SOCK_DIR="$SOCK_DIR/pgbouncer"
export PGB_LOG_FILE="$LOG_DIR/pgbouncer.log"
export PGB_PORT=6432
export PGB_USER=pgbouncer
export PGB_PASSWORD="$(get_secret pgbouncer)"

export HOME="$PGB_HOME"
export XDG_CONFIG_HOME="$PGB_CONFIG"

export PGB_MAX_DB_CONNECTIONS="$(get_max_db_connections)"

copy_pgbouncer_config() {
    export PG_MD5=$(echo -n "$PG_PASSWORD$PG_USER" | md5sum | sed "s/ .*//")
    export PGB_MD5=$(echo -n "$PGB_PASSWORD$PGB_USER" | md5sum | sed "s/ .*//")

    copy_config_as_daemon_user pgbouncer pgbouncer.ini
    copy_config_as_daemon_user pgbouncer userlist.txt
}
