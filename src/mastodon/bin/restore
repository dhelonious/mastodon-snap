#!/bin/bash -e

. "$SNAP/postgres.env"
. "$SNAP/pgbouncer.env"
. "$SNAP/redis.env"
. "$SNAP/mastodon.env"

check_root
check_service postgres
load_tootctl_tuning_env

print_usage() {
    echo "Usage: $SNAP_NAME.restore [-p PATH] NAME"
}

if [ -z "$1" ]; then
    print_usage
    exit 0
fi

backup_dir="$BACKUP_DIR"

while getopts "p:h" OPTION; do
    case "$OPTION" in
    p)
        backup_dir="$OPTARG"

        case "$backup_dir" in
            /media/*|/mnt/*|/run/media/*)
                if ! [ -d "$backup_dir" ]; then
                    echo_error The path $backup_dir does not exist or is not accessible
                    echo_error
                    echo_error External backups can only be accessed if the removable-media interface is connected.
                    echo_error You can connect it using the command: sudo snap connect $SNAP_NAME:removable-media
                    exit 1
                fi
                ;;
            *)
                echo_error "An external backup can only be on a removable media (/media/*, /mnt/*, /run/media/*)"
                exit 1
                ;;
        esac
        ;;
    h)
        print_usage
        exit 0
        ;;
    esac
done
shift "$(($OPTIND-1))"

export_dir="$backup_dir/$1"

if ! [ -d "$export_dir" ]; then
    echo_error "The backup $export_dir does not exist"
    exit 1
fi

confirm "Are you sure you want to restore $1?" || exit 0

echo Restoring backup from $export_dir

BACKUP_VERSION="$(cat $export_dir/version)"
if [ "$BACKUP_VERSION" != "$SNAP_VERSION" ]; then
    echo CAUTION: You are trying to restore a backup from another version!
    echo "Snap version: $SNAP_VERSION"
    echo "Backup version: $BACKUP_VERSION"
    echo The backup may be incompatible or changes may be required.
    read -rp "Do you want to continue? [y/N] " response
    if ! [[ "$response" =~ ^([yY])$ ]]; then
        exit 0
    fi
fi

echo Restoring settings...
cat "$export_dir/settings" | while read setting; do
    snapctl set $setting
done

if [ "$(snapctl get media.dir)" != "$(get_media_dir_link)" ]; then
    echo Linking media dir...
    link_media_dir
fi

echo Stopping services...
stop_service nginx
stop_service backend
stop_service sidekiq
stop_service streaming

echo Restoring configuration...
rsync --ignore-times --no-owner --no-perms --chmod u+rw,g+rw,o-rwx --chown $DAEMON_USER:root "$export_dir/mastodon.conf" "$SNAP_COMMON/"

mastodon_set_var DB_PASS "$(get_secret postgres)"
# mastodon_set_var REDIS_PASSWORD "$(get_secret redis)"

if mastodon_database_exists; then
    echo Dropping old database...
    $SNAP/bin/psql.wrapper -c "drop owned by $PG_USER cascade;"
    $SNAP/bin/psql.wrapper -c "drop database if exists $MASTODON_DB;"
    # $SNAP/bin/psql.wrapper -c "drop role if exists $PG_USER;"
    # $SNAP/bin/psql.wrapper -c "drop role if exists $PGB_USER;"
fi

echo Setting up database users...
mastodon_create_db_users

echo Restoring database...
postgres_waitready
$SNAP/bin/psql.wrapper -f "$export_dir/database.sql" template1 > /dev/null
if [ "$BACKUP_VERSION" != "$SNAP_VERSION" ]; then
    if confirm "Do you want to start a database migration?"; then
        mastodon_db_migrate
    elif confirm "Do you want to start a database rollback instead?"; then
        mastodon_db_rollback
    fi
fi

if [ -f "$export_dir/redis.rdb" ]; then
    echo Restoring redis database...
    stop_service redis
    run_as_daemon_user cp "$export_dir/redis.rdb" "$REDIS_DATA/"
    start_service redis
fi

if [ -d "$export_dir/certs" ]; then
    echo Restoring certificates...
    cp -r "$export_dir/certs/"* "$CERT_DIR/"
fi

echo Cleaning up media references...
mastodon_tootctl preview_cards remove --days 1 --concurrency $TOOTCTL_CONCURRENCY
mastodon_tootctl media remove --days 1 --concurrency $TOOTCTL_CONCURRENCY

if [ -f "$export_dir/media.tar.gz" ]; then
    echo Restoring uploads...
    run_as_daemon_user tar -xzf "$export_dir/media.tar.gz" -C "$MEDIA_DIR" --strip-components=1 --no-same-permissions --no-same-owner --skip-old-files

    echo The following action may take a long time to complete
    confirm "Refresh recent media?" && \
        mastodon_tootctl media refresh --days 1 --force --concurrency $TOOTCTL_CONCURRENCY

    echo The following action may take a long time to complete
    confirm "Refresh remote account avatars and headers?" && \
        mastodon_tootctl accounts refresh --all --force --concurrency $TOOTCTL_CONCURRENCY
fi

$SNAP/bin/recompile_if_required

echo Restarting services...
start_service backend
start_service sidekiq
start_service streaming
start_service nginx
