#!/bin/bash -e

. "$SNAP/acme.env"
. "$SNAP/logrotate.env"
. "$SNAP/mastodon.env"
. "$SNAP/nginx.env"
. "$SNAP/postgres.env"
. "$SNAP/redis.env"
. "$SNAP/snap.env"
. "$SNAP/settings.env"

echo_border "=" "Debug report for snap version $(cat "$SNAP_COMMON/version")"

echo
echo NOTE: This report contains your domain name and email address. Please review this information carefully before sharing it.

echo
echo_underline "=" "Settings"
echo

for setting in $(sed "s/[.,].*//" <<< "$SETTINGS" | sort -u); do
    echo "$setting: $(snapctl get $setting)"
done
echo "snap: $(snapctl get snap)"
echo "service: $(snapctl get service)"

echo
echo_underline "=" "Files and directories"
echo

print_tree() {
    cd /tmp && \
    find "$1" -maxdepth 3 \
        \( \
            -type d ! -readable -o \
            -path "*/data/*" -o \
            -path "*/mastodon/*" -o \
            -path "*/media/*" \
        \) -prune -o \
        -type f -printf "%p (%u:%g %m)\n" -o \
        -type d -printf "%p# (%u:%g %m)\n" \
    | sed -e "s|^/var/snap/$SNAP_NAME/||" \
        -e '2,$s|[^/]*/|  |g' \
        -E -e "s|/?#|/|"
}

print_tree "$SNAP_COMMON" || true
print_tree "$SNAP_DATA" || true

echo
echo_underline "=" "Environment"
echo

test -n "$PG_PASSWORD" && PG_PASSWORD="********"
test -n "$PGB_PASSWORD" && PGB_PASSWORD="********"
# test -n "$REDIS_PASSWORD" && REDIS_PASSWORD="********"
test -n "$SMTP_PASSWORD" && SMTP_PASSWORD="********"

printenv | sort

echo
echo_underline "=" "Tuning"
echo

begin_print_env
load_postgres_tuning_env
load_nginx_tuning_env
load_backend_tuning_env
load_sidekiq_tuning_env
load_streaming_tuning_env
end_print_env
