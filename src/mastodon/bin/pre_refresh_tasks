#!/bin/bash -e

. "$SNAP/postgres.env"
. "$SNAP/mastodon.env"
. "$SNAP/debug.env"

trap reset_pre_refresh_tasks_required EXIT

begin_debug pre_refresh_tasks

if ! is_pre_refresh_tasks_required; then
    exit 0
fi

check_setup

echo Create database backup
postgres_export_database "$SNAP_COMMON/database.sql"

if $UPDATE_BACKUP; then
    echo Create update backup
    SKIP_MEDIA_EXPORT=true $SNAP/bin/export "$UPDATE_BACKUP_DIR"
fi

echo Start pre-deployment db migrations
SKIP_POST_DEPLOYMENT_MIGRATIONS=true mastodon_db_migrate
