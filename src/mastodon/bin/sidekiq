#!/bin/bash -e

. "$SNAP/mastodon.env"
. "$SNAP_CURRENT/server.conf"

check_setup
postgres_waitready
pgbouncer_waitready
redis_waitready
migrations_waitready
load_mastodon_env
load_sidekiq_tuning_env

export MALLOC_ARENA_MAX=2

case "$1" in
    high)
        concurrency=$(( SIDEKIQ_CONCURRENCY * 3 / 6 ))
        log_file=sidekiq-high.log
        ;;
    medium)
        concurrency=$(( SIDEKIQ_CONCURRENCY * 2 / 6  ))
        log_file=sidekiq-medium.log
        ;;
    low)
        concurrency=$(( SIDEKIQ_CONCURRENCY * 1 / 6 ))
        log_file=sidekiq-low.log
        ;;
    *)
        concurrency=$SIDEKIQ_CONCURRENCY
        log_file=sidekiq.log
        ;;
esac

cd "$MASTODON_HOME" && \
    run_as_daemon_user bundle exec sidekiq -c $concurrency "$@" \
    2>&1 | tee -a "$LOG_DIR/$log_file"
