#!/bin/bash -e

. "$SNAP/mastodon.env"
. "$SNAP/postgres.env"
. "$SNAP/redis.env"
. "$SNAP/settings.env"

check_root
check_setup
check_service postgres

print_usage() {
    echo "Usage: $SNAP_NAME.export [-p PATH] [NAME]"
}

backup_dir="$BACKUP_DIR"

while getopts "p:h" OPTION; do
    case "$OPTION" in
    p)
        backup_dir="$OPTARG"

        case "$backup_dir" in
            /media/*|/mnt/*|/run/media/*)
                if ! [ -d "$backup_dir" ]; then
                    echo_error The path $backup_dir does not exist or is not accessible
                    echo_error
                    echo_error External backups can only be accessed if the removable-media interface is connected.
                    echo_error You can connect it using the command: sudo snap connect $SNAP_NAME:removable-media
                    exit 1
                fi
                ;;
            *)
                echo_error "An external backup can only be on a removable media (/media/*, /mnt/*, /run/media/*)"
                exit 1
                ;;
        esac
        ;;
    h)
        print_usage
        exit 0
        ;;
    esac
done
shift "$(($OPTIND-1))"

if [ -n "$1" ]; then
    export_dir="$backup_dir/$1"
else
    export_dir="$backup_dir/$(date +'%Y%m%d-%H%M%S')"
fi

if [ -d "$export_dir" ]; then
    echo_error "The backup $export_dir does aleady exist"
    echo_error
    echo_error "Please choose another name or remove $export_dir manually."
    exit 1
fi

mkdir -p "$export_dir"
echo "Exporting backup to $export_dir..."

echo Exporting version...
cp "$SNAP_COMMON/version" "$export_dir/"

echo Exporting settings...
for setting in $SETTINGS; do
    setting_key=${setting%,*}
    echo "$setting_key=$(snapctl get $setting_key)" >> "$export_dir/settings"
done

echo Exporting configuration...
rsync_clean "$SNAP_COMMON/mastodon.conf" "$export_dir/"

echo Exporting database...
postgres_export_database "$export_dir/database.sql"
sed -ri "1,100s/^(CREATE ROLE postgres;)/-- \1/" "$export_dir/database.sql"
sed -ri "1,100s/^(CREATE ROLE $PG_USER;)/-- \1/" "$export_dir/database.sql"

if [ -s "$REDIS_DATA/redis.rdb" ]; then
    if redis_waitready; then
        redis_save
    fi
    echo Exporting redis database...
    rsync_clean "$REDIS_DATA/redis.rdb" "$export_dir/"
fi

if [ -n "$(ls -A $CERT_DIR)" ]; then
    echo Exporting certificates...
    cp -r "$CERT_DIR" "$export_dir/"
fi

if [ -z "$SKIP_MEDIA_EXPORT" ]; then
    if ! [ -z "$(ls -A $MEDIA_DIR)" ]; then
        echo Exporting media...
        tar -czf "$export_dir/media.tar.gz" -C "$(dirname $MEDIA_DIR)" --exclude=*/cache "$(basename $MEDIA_DIR)"
    fi
fi

echo Export finished successfully!
if [ "$BACKUP_DIR" == "$DEFAULT_BACKUP_DIR" ]; then
    echo
    echo [!] You are currently using the default backup directory.
    echo Make sure you copy $export_dir to a safe location. Otherwise, your export will be deleted when you uninstall the snap. To permantently change the location of the backup directory, use 'snap set mastodon-server backup.dir=/mnt/backups'.
fi
