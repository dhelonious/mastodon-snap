#!/bin/bash -e

. "$SNAP/mastodon.env"

if [ "$(snapctl get migration-required)" == true ]; then
    postgres_waitready
    mastodon_rails db:migrate
    mastodon_rails log:clear tmp:clear
    reset_migration_required
    reset_pre_migration_required
elif [ "$(snapctl get pre-migration-required)" == true ]; then
    postgres_waitready
    SKIP_POST_DEPLOYMENT_MIGRATIONS=true \
        mastodon_rails db:migrate
    mastodon_rails log:clear tmp:clear
    reset_pre_migration_required
fi

