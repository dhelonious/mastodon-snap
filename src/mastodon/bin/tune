#!/bin/bash -e

. "$SNAP/snap.env"

check_system_cpu
check_system_ram
check_system_ssd

. "$SNAP/postgres.env"
. "$SNAP/nginx.env"
. "$SNAP/mastodon.env"

begin_print_env
load_postgres_tuning_env
load_nginx_tuning_env
load_backend_tuning_env
load_sidekiq_tuning_env
load_streaming_tuning_env
end_print_env

if ! confirm "Do you want to tune the instance based on these values?"; then
    exit 0
fi

echo Update postgres config
copy_postgres_config

echo Update nginx configs
copy_nginx_configs

echo Restart services
snapctl restart "$SNAP_NAME.postgres"
postgres_waitready
snapctl restart "$SNAP_NAME.backend"
snapctl restart "$SNAP_NAME.streaming"
snapctl restart "$SNAP_NAME.sidekiq"
snapctl restart "$SNAP_NAME.nginx"
