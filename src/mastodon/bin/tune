#!/bin/bash -e

. "$SNAP/snap.env"

print_usage() {
    echo "Usage: $SNAP_NAME.tune [-c number of CPUs] [-r RAM in GB] [-s SSD]"
}

while getopts "c:r:s:h" OPTION; do
    case "$OPTION" in
    c)
        if is_number "$OPTARG"; then
            snapctl set system.cpu="$OPTARG"
            export SYSTEM_CPU="$OPTARG"
            system_cpu_optarg=true
        else
            echo_error "Invalid number of CPUs: '$OPTARG'"
            exit 1
        fi
        ;;
    r)
        if is_number "$OPTARG"; then
            snapctl set system.ram="$OPTARG"
            export SYSTEM_RAM="$OPTARG"
            system_ram_optarg=true
        else
            echo_error "Invalid value for RAM: '$OPTARG'"
            exit 1
        fi
        ;;
    s)
        case "$OPTARG" in
            true|yes)
                snapctl set system.ssd=true
                export SYSTEM_SSD=true
                system_ssd_optarg=true
                ;;
            false|no)
                snapctl set system.ssd=false
                export SYSTEM_SSD=false
                system_ssd_optarg=true
                ;;
            *)
                echo_error "The value of -s must be boolean"
                exit 1
                ;;
        esac
        ;;
    h)
        print_usage
        exit 0
        ;;
    esac
done
shift "$(($OPTIND-1))"

if ! [ ${system_cpu_optarg:-false} == true ]; then
    while ! is_number "$SYSTEM_CPU"; do
        read -p "Enter the number of CPU cores available: " -ei "$SYSTEM_CPU" SYSTEM_CPU
    done
    export SYSTEM_CPU=$SYSTEM_CPU
fi

if ! [ ${system_ram_optarg:-false} == true ]; then
    while ! is_number "$SYSTEM_RAM"; do
        read -p "Enter the amount of RAM available in GB: " -ei "$SYSTEM_RAM" SYSTEM_RAM
    done
    export SYSTEM_RAM="$((SYSTEM_RAM * GB))"
fi

if ! [ ${system_ssd_optarg:-false} == true ]; then
    if ! is_boolean "$SYSTEM_SSD"; then
        if confirm "Is $SNAP_NAME installed on an SSD?"; then
            export SYSTEM_SSD=true
        else
            export SYSTEM_SSD=false
        fi
    fi
fi

. "$SNAP/postgres.env"
. "$SNAP/nginx.env"
. "$SNAP/mastodon.env"

begin_print_env
load_postgres_tuning_env
load_nginx_tuning_env
load_backend_tuning_env
load_sidekiq_tuning_env
load_streaming_tuning_env
end_print_env

if ! confirm "Do you want to tune the instance based on these values?"; then
    exit 0
fi

echo Update snap settings
snapctl set system.cpu=$SYSTEM_CPU
snapctl set system.ram=$SYSTEM_RAM
snapctl set system.ssd=$SYSTEM_SSD

echo Update postgres config
copy_postgres_config

echo Update nginx configs
copy_nginx_configs

echo Restart services
snapctl restart "$SNAP_NAME.postgres"
postgres_waitready
snapctl restart "$SNAP_NAME.backend"
snapctl restart "$SNAP_NAME.streaming"
snapctl restart "$SNAP_NAME.sidekiq"
snapctl restart "$SNAP_NAME.nginx"
