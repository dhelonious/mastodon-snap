#!/bin/bash -e

. "$SNAP/debug.env"

trap end_debug_log EXIT
begin_debug_log pre-refresh

. "$SNAP/snap.env"
. "$SNAP/postgres.env"
. "$SNAP/mastodon.env"

update_postgres_version_file

if mastodon_config_exists; then

    if $UPDATE_ANNOUNCEMENTS; then
        echo Add update announcement
        if ANNOUNCEMENT_ID=$(mastodon_publish_announcement "The server will be updated in 5 minutes and will be unavailable for a short time"); then
            snapctl set system.announcement-id="$ANNOUNCEMENT_ID"
            snapctl restart "$SNAP_NAME.sidekiq"
        fi
    fi

    echo Create database backup
    postgres_export_database "$SNAP_COMMON/database.sql"
    sed -ri "1,100s/^(CREATE ROLE postgres;)/-- \1/" "$SNAP_COMMON/database.sql"

    if $UPDATE_ANNOUNCEMENTS; then
        # NOTE: The pre-refresh hook will be terminated automatically after 5 minutes
        sleep 300
    fi

fi
